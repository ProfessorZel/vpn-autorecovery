# Мониторинг связей между серверами и автоматическое восстановление
Этот Python-скрипт предназначен для мониторинга доступности сервисов на удаленных серверах и автоматического выполнения восстановительных команд в случае недоступности. Скрипт поддерживает экспоненциальный backoff, многопытные проверки доступности и интеграцию с Telegram для уведомлений.
## Особенности
- Периодическая проверка доступности сервисов через HTTP запросы
- Автоматическое выполнение команд восстановления через SSH
- Отправка уведомлений в Telegram при сбоях и восстановлении
- Экспоненциальное увеличение интервала проверок при повторных сбоях
- Многопытная проверка перед признанием недоступности
- Логирование всех операций с ротацией лог-файлов
- Гибкая конфигурация через .env файл
## Требования
- Python 3.6+
- Установленные зависимости: `pip install -r requirements.txt`
## Конфигурация
Все параметры задаются через `.env` файл. Создайте файл `.env` в той же директории, что и скрипт, и заполните его параметрами.
### Обязательные параметры
| Параметр | Описание | Пример |
|----------|----------|--------|
| `INTERVAL` | Базовый интервал проверок в секундах | `30` |
| `MAPPINGS` | Пары серверов в формате `DC:SRV`, разделенные запятыми | `DC3:SRV4,DC1:SRV5` |
| `SRV{name}_URL` | URL для проверки сервиса на сервере SRV (замените `{name}` на имя SRV) | `SRV4_URL=http://srv4.example.com/health` |
| `DC{name}_SSH_HOST` | Хост для подключения по SSH к серверу DC (замените `{name}` на имя DC) | `DC3_SSH_HOST=dc3.example.com` |
| `DC{name}_SSH_USERNAME` | Имя пользователя для SSH подключения | `DC3_SSH_USERNAME=admin` |
| `COMMAND` | Команда для выполнения при недоступности сервиса | `systemctl restart network-service` |
| `TELEGRAM_BOT_TOKEN` | Токен Telegram бота | `1234567890:AAFmBbQdvwWCD2fI4u7Fk5Z1J2K3L4M5N6O7P` |
| `TELEGRAM_CHAT_ID` | ID чата для отправки уведомлений | `-1001234567890` |
### Опциональные параметры
| Параметр | Описание | Значение по умолчанию | Пример |
|----------|----------|----------------------|--------|
| `MAX_INTERVAL` | Максимальный интервал проверки в секундах | `300` | `600` |
| `BACKOFF_FACTOR` | Множитель для увеличения интервала при сбоях (≥1.0) | `2.0` | `1.5` |
| `CHECK_ATTEMPTS` | Количество попыток проверки перед признанием недоступности | `3` | `5` |
| `CHECK_RETRY_DELAY` | Задержка между попытками проверки в секундах | `1.0` | `0.5` |
| `DC{name}_SSH_PORT` | Порт для SSH подключения | `22` | `2222` |
| `DC{name}_SSH_PASSWORD` | Пароль для SSH аутентификации | - | `mysecretpassword` |
| `DC{name}_SSH_KEY_PATH` | Путь к файлу приватного ключа для SSH | - | `/path/to/key.pem` |
| `LOG_FILE` | Имя файла для логирования | `monitor.log` | `app.log` |
| `LOG_MAX_SIZE` | Максимальный размер лог-файла в MB | `10` | `20` |
| `LOG_BACKUP_COUNT` | Количество бэкап-файлов логов | `3` | `5` |
| `LOG_SUCCESS_REQUESTS` | Логировать успешные запросы (`true`/`false`) | `false` | `true` |
### Пример .env файла
```ini
# Базовые настройки
INTERVAL=30
MAPPINGS=DC3:SRV4,DC1:SRV5
COMMAND=systemctl restart network-service
# URL для проверки
SRV4_URL=http://srv4.example.com/health
SRV5_URL=http://srv5.example.com/ping
# SSH для DC3
DC3_SSH_HOST=dc3.example.com
DC3_SSH_USERNAME=admin
DC3_SSH_PASSWORD=password
# SSH для DC1
DC1_SSH_HOST=dc1.example.com
DC1_SSH_USERNAME=root
DC1_SSH_KEY_PATH=/path/to/key.pem
# Telegram
TELEGRAM_BOT_TOKEN=1234567890:AAFmBbQdvwWCD2fI4u7Fk5Z1J2K3L4M5N6O7P
TELEGRAM_CHAT_ID=-1001234567890
# Дополнительные параметры
MAX_INTERVAL=600
BACKOFF_FACTOR=1.5
CHECK_ATTEMPTS=5
CHECK_RETRY_DELAY=0.5
LOG_SUCCESS_REQUESTS=false
```
## Установка и запуск
1. Клонируйте репозиторий или скопируйте скрипт
2. Установите зависимости:
   ```bash
   pip install python-dotenv requests paramiko
   ```
3. Создайте файл `.env` с конфигурацией
4. Запустите скрипт:
   ```bash
   python monitor.py
   ```
Для запуска в фоновом режиме:
```bash
nohup python monitor.py > monitor.log 2>&1 &
```
## Принцип работы
1. Скрипт загружает конфигурацию из `.env` файла
2. Для каждой пары серверов из `MAPPINGS`:
   - Выполняется HTTP запрос к URL, указанному в `SRV{name}_URL`
   - Производится `CHECK_ATTEMPTS` попыток с задержкой `CHECK_RETRY_DELAY`
3. Если сервис недоступен после всех попыток:
   - Увеличивается счетчик попыток восстановления
   - Выполняется SSH подключение к соответствующему DC серверу
   - Выполняется команда, указанная в `COMMAND`
   - Применяется экспоненциальный backoff с множителем `BACKOFF_FACTOR`
   - Отправляется уведомление в Telegram
4. Если сервис доступен после предыдущего сбоя:
   - Сбрасывается интервал проверки и счетчик попыток
   - Отправляется уведомление о восстановлении
5. Процесс повторяется с новым интервалом
## Примеры уведомлений в Telegram
**Первое обнаружение недоступности:**
```
**Статус связи DC3-SRV4:** ⚠️ Нарушено
**Сообщение:** Недоступность после 3 попыток проверки. Выполнена команда: `systemctl restart network-service`
**Следующая проверка:** через 30 сек
```
**Повторная недоступность:**
```
**Статус связи DC3-SRV4:** ⚠️ Нарушено (Попытка восстановления #2)
**Сообщение:** Сервис все еще недоступен после 2 попыток восстановления. Последняя команда: `systemctl restart network-service`
Проверочных попыток: 3, множитель задержки: 1.5
**Следующая проверка:** через 67.5 сек
```
**Восстановление:**
```
**Статус связи DC3-SRV4:** ✅ Восстановлено (Попытка восстановления #3)
**Сообщение:** Сервис восстановлен: DC3-SRV4 после 3 попыток
**Следующая проверка:** через 30 сек
```
## Логирование
Скрипт ведет подробное логирование в файл (по умолчанию `monitor.log`). Примеры записей:
```
2023-10-15 12:30:45 - INFO - Старт мониторинга с интервалом 30 сек
2023-10-15 12:30:45 - INFO - Отслеживаемые пары: DC3-SRV4, DC1-SRV5
2023-10-15 12:31:15 - WARNING - Проверка DC3-SRV4 (http://srv4.example.com/health): Недоступен [0ms] (попыток: 3/3)
2023-10-15 12:31:15 - INFO - Выполнение команды на DC3 (Попытка восстановления #1): systemctl restart network-service
2023-10-15 12:31:15 - INFO - COMMAND_EXECUTED: {"timestamp": "2023-10-15T09:31:15.123456", "pair": "DC3-SRV4", "dc_host": "dc3.example.com", "command": "systemctl restart network-service", "output": "Restarting network-service... OK", "status": "executed"}
2023-10-15 12:31:15 - INFO - Команда выполнена успешно на DC3 (Попытка восстановления #1)
```
## Важные замечания
1. Для работы SSH подключения необходимо:
   - Иметь доступ к серверам по SSH
   - Настроить аутентификацию (пароль или SSH-ключ)
   - Убедиться, что пользователь имеет права на выполнение команды
2. Telegram бот должен:
   - Быть создан через @BotFather
   - Иметь разрешение на отправку сообщений в указанный чат
   - Чат ID должен быть предварительно получен
3. При первом запуске рекомендуется:
   - Установить `LOG_SUCCESS_REQUESTS=true`
   - Проверить корректность всех настроек
   - Убедиться в работе восстановительной команды
4. Для отладки можно:
   - Временно уменьшить интервалы проверки
   - Использовать тестовые команды (например, `echo "Test"`)
   - Проверить логи на наличие ошибок
## Обратная связь
Если у вас есть вопросы или предложения по улучшению скрипта, создайте issue в репозитории проекта.
```
Этот README.md содержит все необходимые инструкции для настройки и использования скрипта.
